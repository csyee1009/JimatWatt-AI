<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDG XI - Energy Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .transition-width {
            transition-property: max-width, width;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 700ms;
        }
    </style>
</head>

<body class="bg-slate-50 flex items-center justify-center min-h-screen font-sans p-4">

    <div id="mainCard"
        class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full max-w-md border border-gray-100 flex flex-col gap-8 transition-width duration-700 ease-in-out relative overflow-hidden">

        <div class="absolute top-0 left-0 w-full h-2 bg-blue-600" id="topBorder"></div>

        <div id="formSection" class="w-full transition-all duration-500 flex flex-col justify-center">
            <div class="mb-8">
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Energy Forecast AI</h1>
                <p class="text-blue-600 font-semibold text-sm mt-1">SDG XI Hackathon Project</p>
            </div>

            <form id="predictionForm" class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Day of
                        Week</label>
                    <select id="day"
                        class="w-full p-3 bg-slate-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-medium text-gray-700 cursor-pointer hover:bg-slate-100 transition-colors">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Temp
                            (Â°C)</label>
                        <input type="number" id="temp" step="0.1" value="26.5"
                            class="w-full p-3 bg-slate-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-gray-700">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Family
                            Size</label>
                        <input type="number" id="size" value="4" min="1" step="1" oninput="validity.valid||(value='');"
                            class="w-full p-3 bg-slate-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-gray-700">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Has
                            AC?</label>
                        <select id="ac"
                            class="w-full p-3 bg-slate-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-medium text-gray-700 cursor-pointer">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Peak
                            Usage</label>
                        <input type="number" id="peak" step="0.1" value="5.5" min="0"
                            oninput="validity.valid||(value='');"
                            class="w-full p-3 bg-slate-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-gray-700">
                    </div>
                </div>

                <div class="pt-5 border-t border-gray-100">
                    <label class="flex items-center gap-3 mb-3 cursor-pointer group relative w-fit">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="solarToggle" class="peer sr-only">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </div>
                        <span
                            class="text-sm font-bold text-gray-600 group-hover:text-blue-600 transition-colors select-none">I
                            have Solar Panels</span>
                    </label>

                    <div id="solarInputBox"
                        class="hidden transition-all duration-300 bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                        <label class="text-xs font-bold text-yellow-700 uppercase tracking-wider mb-1 block">Panel Size
                            (kW)</label>
                        <input type="number" id="solarSize" step="0.5" value="5.0" min="0"
                            oninput="validity.valid||(value='');"
                            class="w-full p-2 bg-white border border-yellow-300 rounded-lg font-bold text-gray-800 outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-2">
                    <span>Calculate Forecast</span>
                    <i class="fas fa-arrow-right text-sm"></i>
                </button>
            </form>
        </div>

        <div id="resultSection"
            class="hidden opacity-0 w-full md:w-1/2 flex flex-col transition-opacity duration-1000 border-t md:border-t-0 md:border-l border-gray-100 pt-8 md:pt-0 md:pl-8">
            <div id="resultBox" class="h-full flex flex-col">
            </div>
        </div>

    </div>

    <script>
        let myChart = null;

        function handleSolarToggle() {
            const checkBox = document.getElementById('solarToggle');
            const inputBox = document.getElementById('solarInputBox');
            const topBorder = document.getElementById('topBorder');

            if (checkBox.checked) {
                inputBox.classList.remove('hidden');
                topBorder.className = 'absolute top-0 left-0 w-full h-2 bg-yellow-500 transition-colors duration-500';
            } else {
                inputBox.classList.add('hidden');
                topBorder.className = 'absolute top-0 left-0 w-full h-2 bg-blue-600 transition-colors duration-500';
            }
        }

        document.getElementById('solarToggle').addEventListener('change', handleSolarToggle);

        document.getElementById('predictionForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const mainCard = document.getElementById('mainCard');
            const formSection = document.getElementById('formSection');
            const resultSection = document.getElementById('resultSection');

            // UI Animation
            mainCard.classList.replace('max-w-md', 'max-w-5xl');
            mainCard.classList.add('md:flex-row');
            formSection.classList.add('md:w-1/2');
            resultSection.classList.remove('hidden');
            setTimeout(() => {
                resultSection.classList.remove('opacity-0');
            }, 100);

            // Data Collection
            const sizeVal = parseInt(document.getElementById('size').value);
            const peakVal = parseFloat(document.getElementById('peak').value);
            const solarVal = parseFloat(document.getElementById('solarSize').value);
            const hasSolar = document.getElementById('solarToggle').checked;

            if (sizeVal < 1 || peakVal < 0 || (hasSolar && solarVal < 0)) {
                alert("Please check your inputs. Values cannot be negative.");
                return;
            }

            const resultBox = document.getElementById('resultBox');
            resultBox.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center text-gray-400 space-y-3">
                    <i class="fas fa-circle-notch fa-spin text-3xl text-blue-500"></i>
                    <p class="font-medium animate-pulse">Analyzing Energy Patterns...</p>
                </div>
            `;

            if (myChart) myChart.destroy();

            const formData = {
                Day: document.getElementById('day').value,
                Avg_Temperature_C: parseFloat(document.getElementById('temp').value),
                Household_Size: sizeVal,
                Has_AC: document.getElementById('ac').value,
                Peak_Hours_Usage_kWh: peakVal,
                Has_Solar: hasSolar,
                Solar_Panel_Size_kW: hasSolar ? solarVal : 0
            };

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                let htmlContent = '';
                let finalConfig = {};

                if (data.mode === 'solar') {
                    // SOLAR MODE
                    const isProfit = data.net_energy > 0;
                    const statusColor = isProfit ? "text-green-600" : "text-orange-600";
                    const alertBg = isProfit ? "bg-green-50 border-green-100" : "bg-orange-50 border-orange-100";
                    const icon = isProfit ? "fa-leaf text-green-500" : "fa-bolt text-orange-500";
                    const title = isProfit ? "Eco-Friendly Status" : "Energy Deficit";
                    const message = isProfit
                        ? "Great job! Your solar panels are covering 100% of your needs."
                        : "You are consuming more than you generate. Consider reducing AC usage.";

                    // FIX: Changed condition to show negative sign if not profit
                    // ${isProfit ? '+' : '-'}
                    htmlContent = `
                        <div class="mb-4">
                            <h3 class="text-xl font-bold text-slate-800">Forecast Results</h3>
                            <p class="text-gray-400 text-sm">Solar analysis complete</p>
                        </div>

                        <div class="text-center py-4">
                            <p class="text-xs uppercase font-bold text-gray-400 tracking-wider mb-2">Net Impact</p>
                            <div class="flex items-baseline justify-center gap-1">
                                <span class="text-6xl font-black ${statusColor}">${isProfit ? '+' : '-'}RM${Math.abs(data.bill_impact).toFixed(2)}</span>
                            </div>
                            <p class="text-sm font-medium text-gray-400 mt-1">${isProfit ? "Profit Generated" : "Estimated Cost"}</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-2xl p-4 text-center">
                                <p class="text-xs text-gray-400 font-bold uppercase mb-1">You Use</p>
                                <p class="text-xl font-black text-slate-700">${data.consumption} <span class="text-sm text-gray-400 font-normal">kWh</span></p>
                            </div>
                            <div class="bg-yellow-50 rounded-2xl p-4 text-center">
                                <p class="text-xs text-yellow-600 font-bold uppercase mb-1">Solar Makes</p>
                                <p class="text-xl font-black text-yellow-700">${data.generation} <span class="text-sm text-yellow-600 font-normal">kWh</span></p>
                            </div>
                        </div>

                        <div class="${alertBg} border rounded-2xl p-4 flex items-start gap-3 mb-6">
                            <div class="mt-0.5"><i class="fas ${icon}"></i></div>
                            <div>
                                <h4 class="font-bold text-sm text-slate-800">${title}</h4>
                                <p class="text-xs text-slate-500 mt-1 leading-relaxed">${message}</p>
                            </div>
                        </div>

                        <div class="flex-1 relative w-full min-h-[200px]">
                            <canvas id="energyChart"></canvas>
                        </div>
                    `;

                    finalConfig = {
                        type: 'bar',
                        data: {
                            labels: ['Usage', 'Solar Gen'],
                            datasets: [{
                                data: [data.consumption, data.generation],
                                backgroundColor: ['#ef4444', '#ca8a04'],
                                borderRadius: 8,
                                barThickness: 40
                            }]
                        }
                    };

                } else {
                    // STANDARD MODE
                    const isCritical = data.status === 'CRITICAL';
                    const statusColor = isCritical ? "text-orange-600" : "text-green-600";
                    let alertHtml = isCritical
                        ? `<div class="bg-orange-50 border border-orange-100 rounded-2xl p-4 flex items-start gap-3 mb-6">
                            <div class="mt-0.5"><i class="fas fa-bolt text-orange-500"></i></div>
                            <div><h4 class="font-bold text-sm text-orange-800">High Usage Alert</h4><p class="text-xs text-orange-700/80 mt-1 leading-relaxed">Your predicted usage is above the safe threshold.</p></div></div>`
                        : `<div class="bg-green-50 border border-green-100 rounded-2xl p-4 flex items-start gap-3 mb-6">
                            <div class="mt-0.5"><i class="fas fa-check-circle text-green-500"></i></div>
                            <div><h4 class="font-bold text-sm text-green-800">Efficiency Good</h4><p class="text-xs text-green-700/80 mt-1 leading-relaxed">Your consumption is within the safe threshold.</p></div></div>`;

                    htmlContent = `
                        <div class="mb-2">
                            <h3 class="text-xl font-bold text-slate-800">Forecast Results</h3>
                            <p class="text-gray-400 text-sm">Prediction analysis will appear here</p>
                        </div>

                        <div class="text-center py-6">
                            <p class="text-xs uppercase font-bold text-gray-400 tracking-wider mb-2">Predicted Consumption</p>
                            <div class="flex items-baseline justify-center gap-2">
                                <span class="text-6xl font-black text-slate-800 tracking-tighter">${data.prediction}</span>
                                <span class="text-xl text-gray-400 font-medium">kWh</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 rounded-2xl p-4 text-center">
                                <p class="text-xs text-gray-400 font-bold uppercase mb-2">Status</p>
                                <p class="text-lg font-bold ${statusColor} tracking-wide">${data.status}</p>
                            </div>
                            <div class="bg-gray-50 rounded-2xl p-4 text-center">
                                <p class="text-xs text-gray-400 font-bold uppercase mb-2">Safe Threshold</p>
                                <p class="text-lg font-bold text-slate-700 tracking-wide">${data.threshold} kWh</p>
                            </div>
                        </div>

                        ${alertHtml}

                        <div class="flex-1 relative w-full min-h-[200px]">
                            <canvas id="energyChart"></canvas>
                        </div>
                    `;

                    finalConfig = {
                        data: {
                            labels: ['', 'Usage', ''],
                            datasets: [
                                {
                                    type: 'bar',
                                    label: 'Usage',
                                    data: [null, data.prediction, null],
                                    backgroundColor: isCritical ? '#ea580c' : '#22c55e',
                                    borderRadius: 12,
                                    barThickness: 60,
                                    order: 2
                                },
                                {
                                    type: 'line',
                                    label: 'Safe Limit',
                                    data: [data.threshold, data.threshold, data.threshold],
                                    borderColor: '#94a3b8',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    pointRadius: 0,
                                    tension: 0,
                                    order: 1
                                }
                            ]
                        }
                    };
                }

                resultBox.innerHTML = htmlContent;

                const ctx = document.getElementById('energyChart').getContext('2d');
                myChart = new Chart(ctx, {
                    ...finalConfig,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9', drawBorder: false },
                                ticks: { font: { size: 10 }, color: '#94a3b8' }
                            },
                            x: {
                                grid: { display: false, drawBorder: false },
                                ticks: { display: true, font: { weight: 'bold' }, color: '#64748b' }
                            }
                        }
                    }
                });

            } catch (err) {
                resultBox.innerHTML = `<div class="bg-red-50 p-4 rounded-xl border border-red-100 text-center"><p class="text-red-500 font-bold">Error: ${err.message}</p></div>`;
            }
        });
    </script>
</body>

</html>